<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Leo Smith's website, specialized in cyber security research, programming and audit. This website also contains my personal cyber security write ups and tools.">
  <meta name="author" content="Leo Smith">

  <title>Leo Smith - HeartBleed</title>

  <!-- Bootstrap core CSS -->
  <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom fonts for this theme -->
  <link href="../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

  <!-- Theme CSS -->
  <link href="../css/freelancer.css" rel="stylesheet">
  <link href="../css/blog-post.css" rel="stylesheet">
  <link rel="shortcut icon" type="image/png" href="../img/favicon.png"/>
  <!-- Custom styles for this template -->

</head>

<body id="page-top">


  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand js-scroll-trigger" href="#page-top">Leo Smith</a>
      <button class="navbar-toggler navbar-toggler-right text-uppercase font-weight-bold bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="../index.html">Home</a>
          </li>
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="../writeups/">Write-Ups</a>
          </li>
          <li class="nav-item mx-0 mx-lg-1">
            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="../projects/">Projects</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <div class="container post">

    <div class="row">

      <!-- Post Content Column -->
      <div class="col-lg-8">

        <!-- Title -->
        <h1 class="mt-4">HeartBleed - TryHackMe</h1>

        <!-- Author -->
        <p class="lead">
          by Leo Smith /
          <a href="https://github.com/p4p1">p4p1</a>
        </p>

        <hr>

        <!-- Date/Time -->
        <p>Created on sat. 02 May 2020</p>

        <hr>

        <!-- Preview Image -->
        <img class="img-fluid rounded" src="https://heartbleed.com/heartbleed.png" alt="">

        <hr>

        <!-- Post Content -->
        <p class="lead">
          Today I completed the
          <a href="https://tryhackme.com/room/heartbleed">
          HeartBleed room of tryhackme</a>. I remember back in
          2014 hearing about this vulnerability and always wanted to exploit it so
          here we are!
        </p>

        <h3 id="vuln">The Vulnerability</h3>

        <p>
          This room is particular it has an awesome section explaining the HeartBleed
          vulnerability, I will try and do my best explaining it as well. Being a big
          fan of C programming I am going to explain the more technical side of this
          vulnerability using the works of
          <a href="https://www.seancassidy.me/diagnosis-of-the-openssl-heartbleed-bug.html">Sean Cassidy</a>.
          His write-up was so helpful to me and I recommend you reading it as well.
        </p>
        <p>
          To begin let's analyse how the packet was saved inside of memory after the
          server received it:
        </p>
        <pre>
          <code class="prettyprint">
            typedef struct ssl3_record_st
              {
                int type;               /* type of record */
                unsigned int length;    /* How many bytes available */
                unsigned int off;       /* read/write offset into 'buf' */
                unsigned char *data;    /* pointer to the record data */
                unsigned char *input;   /* where the decode bytes are */
                unsigned char *comp;    /* only used with decompression - malloc()ed */
                unsigned long epoch;    /* epoch number, needed by DTLS1 */
                unsigned char seq_num[8]; /* sequence number, needed by DTLS1 */
              } SSL3_RECORD;
          </code>
        </pre>
        <p>
          We have to shift our attention to the 2nd and 4th variable. They are
          what's important to us currently. The length is supposed to be the length
          of the data we send, data is where we have the string that contains the
          data. The maximum length for a payload is 65535. If we provide to the
          server a packet of length = 65535 and a data = "\0"; so an empty data.
          The server will try and copy the response back like this:
        </p>
        <pre>
          <code class="prettyprint">
            // payload: is the length of the data -> 65535
            // pl: is the heartbeat data from the user -> "\0"
            // bp: is the data that will be send back -> ?
            s2n(payload, bp);
            memcpy(bp, pl, payload);
          </code>
        </pre>
        <p>
          Understanding this we can clearly see that the server is copying memory
          into the packet that is bigger than the size of our actual data. Using this
          we can dump the machine's data.
        </p>

        <h3 id="recon">Reconnaissance</h3>

        <p>
          As per usual after deploying the machine I started with an nmap:
        </p>
        <pre>
          <code class="prettyprint">
            #[p4p1@computer thm/]$ nmap x.x.x.x

            Starting Nmap 7.60 ( https://nmap.org ) at 2020-05-01 23:58 CEST
            Nmap scan report for ec2-52-16-103-211.eu-west-1.compute.amazonaws.com (x.x.x.x)
            Host is up (0.023s latency).
            Not shown: 996 closed ports
            PORT    STATE    SERVICE
            22/tcp  open     ssh
            25/tcp  filtered smtp
            111/tcp open     rpcbind
            443/tcp open     https

            Nmap done: 1 IP address (1 host up) scanned in 2.07 seconds
          </code>
        </pre>
        <p>
          Seeing that https is open on port 443 I decided to see what I could do.
          The HeartBleed exploit is known as
          <a href="https://www.exploit-db.com/exploits/32745">CVE-2014-0160</a>
          and on the exploit db page there is some source code provided! After
          downloading it and running dos2unix on it (to remove those shitty ^M).
          I was able to see the basics of what I previously explained above. A
          heartbeat packet is send with a bigger size that it should be:
        </p>
        <img class="img-fluid rounded" src="img/heartbleed/code.png" alt="">
        <p></p>
        <p>
          In orange I highlighted the size of the fake hello packet, so 0x4000 or
          16384 in decimal. I then decided to run the exploit to see if this approach
          would work.
        </p>

        <h3 id="exploit">Exploit</h3>

        <p>
          Running this python script I had an output like this:
        </p>
        <img class="img-fluid rounded" src="img/heartbleed/exploit.png" alt="">
        <p></p>
        <p>
          I did cut out a lot of the output because it is such a mess looking at
          all of it and so I don't give you the answer so easily :P.
        </p>

        <hr />

        <p>
          Thank you so much for reading! This room was a lot of fun for me and I
          loved geeking out over how the HeartBleed exploit works. Please share this
          page and look into my other posts you might find something cool.
        </p>
      </div>

      <!-- Sidebar Widgets Column -->
      <div class="col-md-4">

        <!-- Categories Widget -->
        <div class="card my-4">
          <h5 class="card-header">Categories</h5>
          <div class="card-body">
            <div class="row">
              <div class="col-lg-6">
                <ul class="list-unstyled mb-0">
                  <li>
                    <a href="#vuln">The Vulnerability</a>
                  </li>
                  <li>
                    <a href="#recon">Reconnaissance</a>
                  </li>
                  <li>
                    <a href="#exploit">Exploit</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- Dark mode Widget -->
        <div class="card my-4">
          <h5 class="card-header">Dark Mode</h5>
          <div class="card-body">
            <label class="switch">
              <input type="checkbox" id="toggleshade" onclick="shade();shade2();">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        <!-- Share widget -->
        <div class="card my-4">
          <h5 class="card-header">Share</h5>
          <div class="card-body">
            <!-- AddToAny BEGIN -->
            <div class="a2a_kit a2a_kit_size_32 a2a_default_style center">
              <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
              <a class="a2a_button_google_gmail"></a>
              <a class="a2a_button_facebook"></a>
              <a class="a2a_button_twitter"></a>
              <a class="a2a_button_reddit"></a>
            </div>
            <script async src="https://static.addtoany.com/menu/page.js"></script>
            <!-- AddToAny END -->
          </div>
        </div>

        <div class="card my-4">
          <h5 class="card-header">My tryhackme account</h5>
          <div class="card-body">
            <script src="https://tryhackme.com/badge/17154"></script>
          </div>
        </div>


        <div class="card my-4">
          <h5 class="card-header">Links</h5>
          <div class="card-body">
            <div class="row">
              <div class="col-lg-6">
                <ul class="list-unstyled mb-0">
                  <li>
                    <a href="https://tryhackme.com/room/heartbleed">tryhackme page</a>
                  </li>
                  <li>
                    <a href="https://heartbleed.com/">HeartBleed page</a>
                  </li>
                  <li>
                    <a href="https://www.seancassidy.me/diagnosis-of-the-openssl-heartbleed-bug.html">Cassidy's diagnosis</a>
                  </li>
                </ul>
              </div>
              <div class="col-lg-6">
                <ul class="list-unstyled mb-0">
                  <li>
                    <a href="https://tools.ietf.org/html/rfc6520#page-2">RFC 6520</a>
                  </li>
                  <li>
                    <a href="https://www.exploit-db.com/exploits/32745">CVE-2014-0160</a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
    <!-- /.row -->

  </div>
  <!-- /.container -->

  <!-- Footer -->
  <footer class="footer text-center">
    <div class="container">
      <div class="row">

        <div class="col-lg-4 mb-5 mb-lg-0">
          <h4 class="text-uppercase mb-4">Share</h4>
          <!-- AddToAny BEGIN -->
          <div class="a2a_kit a2a_kit_size_32 a2a_default_style center">
            <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
            <a class="a2a_button_google_gmail"></a>
            <a class="a2a_button_facebook"></a>
            <a class="a2a_button_twitter"></a>
            <a class="a2a_button_reddit"></a>
          </div>
          <script async src="https://static.addtoany.com/menu/page.js"></script>
          <!-- AddToAny END -->
        </div>

        <div class="col-lg-4 mb-5 mb-lg-0">
          <h4 class="text-uppercase mb-4">About this page</h4>
          <p class="lead mb-0">Template found <a target="_blank" rel="noopener noreferrer" href="https://startbootstrap.com/themes/freelancer/">here</a>.</p>
        </div>

        <div class="col-lg-4 mb-5 mb-lg-0">
          <h4 class="text-uppercase mb-4">Follow me</h4>
          <a class="btn btn-outline-light btn-social mx-1" href="https://www.linkedin.com/in/leo-smith/">
            <i class="fab fa-fw fa-linkedin-in"></i>
          </a>
          <a class="btn btn-outline-light btn-social mx-1" href="https://github.com/p4p1">
            <i class="fab fa-github"></i>
          </a>
          <a class="btn btn-outline-light btn-social mx-1" href="https://linuxsecurity.expert/p/leo-smith">
              <i class="fab fa-linux"></i>
          </a>
          <a class="btn btn-outline-light btn-social mx-1" href="https://tryhackme.com/p/p4p1">
              <i class="fas fa-flag-checkered"></i>
          </a>
        </div>

      </div>
    </div>
  </footer>
  <!-- Copyright Section-->
  <section class="copyright py-4 text-center text-white">
    <div class="container"><small>Copyright Â© Leo Smith 2020</small></div>
  </section>
  <!-- Scroll to Top Button (Only visible on small and extra-small screen sizes) -->
  <div class="scroll-to-top d-lg-none position-fixed ">
    <a class="js-scroll-trigger d-block text-center text-white rounded" href="#page-top">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>

  <!-- Bootstrap core JavaScript -->
  <script src="../vendor/jquery/jquery.min.js"></script>
  <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Plugin JavaScript -->
  <script src="../vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Contact Form JavaScript -->
  <script src="../js/jqBootstrapValidation.js"></script>
  <script src="../js/contact_me.js"></script>

  <!-- Custom scripts for this template -->
  <script src="../js/freelancer.min.js"></script>
  <script src="../js/hidden.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163484307-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-163484307-1');
  </script>

  <script>
    var card = document.getElementsByClassName("card");
    var h4Elements = document.getElementsByTagName("h4");
    var dark2=getDarkcookie();
    document.addEventListener('keypress', logKey2);
    if (dark2 == 1) {
      for (var i = 0; i < card.length; i++) {
        card[i].style.backgroundColor = "#423d3d";
      }
    }
    function logKey2(e) {
      if (e.key === 'b') {
        if (dark2 == 0) {
          document.getElementById("toggleshade").checked = true;
          document.cookie = "dark=1";
          for (var i = 0; i < card.length; i++) {
            card[i].style.backgroundColor = "#423d3d";
          }
          for(var i = 0; i < h4Elements.length; i++) {
               h4Elements[i].style.color = "#fff";
          }
          dark2 = 1;
        } else {
          document.getElementById("toggleshade").checked = false;
          document.cookie = "dark=0";
          document.body.style.color = "#000"
          for (var i = 0; i < card.length; i++) {
            card[i].style.backgroundColor = "#FFF";
          }
          for(var i = 0; i < h4Elements.length; i++) {
               h4Elements[i].style.color = "#fff";
          }
          dark2 = 0;
        }
      }
    }
    function shade2() {
      if (dark2 == 0) {
        document.getElementById("toggleshade").checked = true;
        document.cookie = "dark=1";
        for (var i = 0; i < card.length; i++) {
          card[i].style.backgroundColor = "#423d3d";
        }
        for(var i = 0; i < h4Elements.length; i++) {
             h4Elements[i].style.color = "#fff";
        }
        dark2 = 1;
      } else {
        document.getElementById("toggleshade").checked = false;
        document.cookie = "dark=0";
        document.body.style.color = "#000"
        for (var i = 0; i < card.length; i++) {
          card[i].style.backgroundColor = "#FFF";
        }
        for(var i = 0; i < h4Elements.length; i++) {
             h4Elements[i].style.color = "#fff";
        }
        dark2 = 0;
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>

</body>

</html>
